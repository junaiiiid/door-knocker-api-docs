openapi: 3.0.3
info:
  title: Door Knocker Role-Based Authentication API
  description: |
    Complete role-based authentication system built with Supabase Edge Functions and Supabase Auth.

    ## Features
    - Role-based access control (ADMIN, MARKETER, TECHNICIAN)
    - User registration with role assignment
    - Secure authentication using Supabase Auth
    - JWT-based session management
    - Password reset flow
    - Row Level Security (RLS) policies
    - CORS support
    - Comprehensive error handling

    ## User Roles
    - **ADMIN**: Full system access, can manage all users and create other ADMINs
    - **MARKETER**: Marketing-specific permissions
    - **TECHNICIAN**: Technical operations permissions (default role)

    ## Security
    - Passwords managed by Supabase Auth
    - JWT access tokens for authentication
    - Row Level Security (RLS) on database tables
    - Only ADMINs can create other ADMIN users
    - Secure password reset with one-time tokens

  version: 2.0.0
  contact:
    name: Door Knocker API Support
    email: support@doorknocker.example.com

servers:
  - url: https://iywivotqnphrjijztxtu.supabase.co/functions/v1
    description: Production server
  - url: http://localhost:54321/functions/v1
    description: Local development server

security:
  - SupabaseAuth: []

tags:
  - name: Authentication
    description: User authentication and registration operations
  - name: User Management
    description: User profile and information operations
  - name: Password Management
    description: Password reset operations

paths:
  /signUp:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: |
        Creates a new user account with email, password, and role assignment.

        **Role Assignment Rules:**
        - Default role is TECHNICIAN
        - Only authenticated ADMIN users can create other ADMIN users
        - MARKETER and TECHNICIAN roles can be assigned without admin privileges (for initial setup)
        - For production, consider restricting all role assignments to ADMIN users only
      operationId: signUp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignUpRequest'
            examples:
              technician:
                summary: Sign up as technician (default)
                value:
                  email: tech@example.com
                  password: SecurePass123!
                  fullName: John Technician
              marketer:
                summary: Sign up as marketer
                value:
                  email: marketer@example.com
                  password: SecurePass123!
                  fullName: Jane Marketer
                  role: MARKETER
              admin:
                summary: Create admin user (requires admin auth)
                value:
                  email: admin@example.com
                  password: SecurePass123!
                  fullName: Admin User
                  role: ADMIN
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignUpResponse'
              example:
                status: success
                message: User created successfully
                user:
                  id: 550e8400-e29b-41d4-a716-446655440000
                  email: tech@example.com
                  fullName: John Technician
                  role: TECHNICIAN
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingFields:
                  summary: Missing required fields
                  value:
                    error: INVALID_INPUT
                    message: Email and password are required
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error: INVALID_EMAIL
                    message: Invalid email format
                weakPassword:
                  summary: Password too weak
                  value:
                    error: WEAK_PASSWORD
                    message: Password must be at least 8 characters long
                invalidRole:
                  summary: Invalid role
                  value:
                    error: INVALID_ROLE
                    message: Invalid role. Must be ADMIN, MARKETER, or TECHNICIAN
        '401':
          description: Unauthorized - Invalid authentication token when creating ADMIN
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: UNAUTHORIZED
                message: Invalid authentication token
        '403':
          description: Forbidden - Only ADMINs can create other ADMINs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: FORBIDDEN
                message: Only ADMIN users can create other ADMIN users
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: EMAIL_EXISTS
                message: An account with this email already exists
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - SupabaseAuth: []
        - BearerAuth: []

  /login:
    post:
      tags:
        - Authentication
      summary: Login existing user
      description: |
        Authenticates a user with email and password using Supabase Auth.
        Returns JWT access token and user information including their role.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: user@example.com
              password: SecurePass123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              example:
                status: success
                message: Login successful
                token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                role: TECHNICIAN
                user:
                  id: 550e8400-e29b-41d4-a716-446655440000
                  email: user@example.com
                  fullName: John Doe
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingFields:
                  summary: Missing required fields
                  value:
                    error: INVALID_INPUT
                    message: Email and password are required
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error: INVALID_EMAIL
                    message: Invalid email format
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: INVALID_CREDENTIALS
                message: Invalid email or password
        '404':
          description: User profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: PROFILE_NOT_FOUND
                message: User profile not found. Please contact support.
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: |
        Invalidates the user's current session.
        Requires a valid JWT token in the Authorization header.
        Client should also clear local storage/cookies after logout.
      operationId: logout
      security:
        - SupabaseAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                status: success
                message: Logout successful
        '401':
          description: Unauthorized - Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingAuth:
                  summary: Missing authorization header
                  value:
                    error: UNAUTHORIZED
                    message: Authorization header is required
                invalidToken:
                  summary: Invalid token
                  value:
                    error: INVALID_TOKEN
                    message: Invalid or expired token
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /getUser:
    get:
      tags:
        - User Management
      summary: Fetch user profile and role
      description: |
        Retrieves the authenticated user's profile information including role, email, and full name.

        **Admin Access:**
        - ADMIN users can fetch any user's profile by providing the `user_id` query parameter
        - Non-admin users can only fetch their own profile

        **Returns:**
        - User ID, email, role, full name, and account creation date
      operationId: getUser
      security:
        - SupabaseAuth: []
        - BearerAuth: []
      parameters:
        - name: user_id
          in: query
          required: false
          description: User ID to fetch (ADMIN only). If omitted, returns the authenticated user's profile.
          schema:
            type: string
            format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetUserResponse'
              examples:
                ownProfile:
                  summary: Get own profile
                  value:
                    status: success
                    data:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      email: tech@example.com
                      role: TECHNICIAN
                      full_name: John Technician
                      created_at: '2025-01-13T10:00:00.000Z'
                adminViewingOther:
                  summary: Admin viewing another user (with user_id param)
                  value:
                    status: success
                    data:
                      id: 660e8400-e29b-41d4-a716-446655440001
                      email: marketer@example.com
                      role: MARKETER
                      full_name: Jane Marketer
                      created_at: '2025-01-12T15:30:00.000Z'
        '401':
          description: Unauthorized - Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingAuth:
                  summary: Missing authorization header
                  value:
                    error: UNAUTHORIZED
                    message: Authorization header is required
                invalidToken:
                  summary: Invalid token
                  value:
                    error: INVALID_TOKEN
                    message: Invalid or expired token
        '403':
          description: Forbidden - Non-admin trying to access another user's profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: FORBIDDEN
                message: Only ADMIN users can view other users' profiles
        '404':
          description: User or profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                userNotFound:
                  summary: User not found
                  value:
                    error: USER_NOT_FOUND
                    message: User not found
                profileNotFound:
                  summary: Profile not found
                  value:
                    error: PROFILE_NOT_FOUND
                    message: User profile not found. Please contact support.
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /forgotPassword:
    post:
      tags:
        - Password Management
      summary: Request password reset
      description: |
        Sends a password reset email to the user using Supabase Auth.
        Always returns success to prevent email enumeration attacks.

        The reset email contains a secure link with an access token that can be used
        with the /resetPassword endpoint.
      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
            example:
              email: user@example.com
      responses:
        '200':
          description: Request processed (always returns success)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                status: success
                message: If the email exists in our system, a password reset link has been sent
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingEmail:
                  summary: Missing email
                  value:
                    error: INVALID_INPUT
                    message: Email is required
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error: INVALID_EMAIL
                    message: Invalid email format
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /resetPassword:
    post:
      tags:
        - Password Management
      summary: Reset password with token
      description: |
        Resets the user's password using the access token from the password reset email.

        **Flow:**
        1. User receives password reset email from /forgotPassword
        2. User clicks the reset link (contains access_token in URL)
        3. Frontend extracts the access_token and calls this endpoint with new password
        4. Password is updated and user can login with new credentials
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
            example:
              access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
              newPassword: NewSecurePass123!
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                status: success
                message: Password has been reset successfully
        '400':
          description: Invalid input or weak password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingFields:
                  summary: Missing required fields
                  value:
                    error: INVALID_INPUT
                    message: Access token and new password are required
                weakPassword:
                  summary: Password too weak
                  value:
                    error: WEAK_PASSWORD
                    message: Password must be at least 8 characters long
        '401':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: INVALID_TOKEN
                message: Invalid or expired reset token
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    SignUpRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: User's password (minimum 8 characters)
          example: SecurePass123!
        fullName:
          type: string
          description: User's full name (optional)
          example: John Doe
        role:
          type: string
          enum: [ADMIN, MARKETER, TECHNICIAN]
          description: User role (default is TECHNICIAN). ADMIN role requires authenticated ADMIN user.
          example: TECHNICIAN

    SignUpResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        message:
          type: string
          example: User created successfully
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
              example: 550e8400-e29b-41d4-a716-446655440000
            email:
              type: string
              format: email
              example: user@example.com
            fullName:
              type: string
              nullable: true
              example: John Doe
            role:
              type: string
              enum: [ADMIN, MARKETER, TECHNICIAN]
              example: TECHNICIAN

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        password:
          type: string
          format: password
          description: User's password
          example: SecurePass123!

    LoginResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        message:
          type: string
          example: Login successful
        token:
          type: string
          description: JWT access token from Supabase Auth
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI1NTBlODQwMC1lMjliLTQxZDQtYTcxNi00NDY2NTU0NDAwMDAiLCJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJpYXQiOjE3MDAwMDAwMDAsImV4cCI6MTcwMDAwMzYwMH0.signature
        role:
          type: string
          enum: [ADMIN, MARKETER, TECHNICIAN]
          description: User's assigned role
          example: TECHNICIAN
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
              example: 550e8400-e29b-41d4-a716-446655440000
            email:
              type: string
              format: email
              example: user@example.com
            fullName:
              type: string
              nullable: true
              example: John Doe

    ForgotPasswordRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com

    ResetPasswordRequest:
      type: object
      required:
        - access_token
        - newPassword
      properties:
        access_token:
          type: string
          description: Access token from password reset email URL
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        newPassword:
          type: string
          format: password
          minLength: 8
          description: New password (minimum 8 characters)
          example: NewSecurePass123!

    GetUserResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
              description: User's unique identifier
              example: 550e8400-e29b-41d4-a716-446655440000
            email:
              type: string
              format: email
              description: User's email address
              example: tech@example.com
            role:
              type: string
              enum: [ADMIN, MARKETER, TECHNICIAN]
              description: User's assigned role
              example: TECHNICIAN
            full_name:
              type: string
              nullable: true
              description: User's full name
              example: John Technician
            created_at:
              type: string
              format: date-time
              description: Account creation timestamp
              example: '2025-01-13T10:00:00.000Z'

    MessageResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        message:
          type: string
          description: Success message
          example: Operation completed successfully

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error code
          example: INVALID_INPUT
        message:
          type: string
          description: Human-readable error message
          example: Email and password are required

  securitySchemes:
    SupabaseAuth:
      type: apiKey
      in: header
      name: apikey
      description: |
        Supabase anon/public key. Required for all requests to Supabase Edge Functions.
        Get this from your Supabase Dashboard > Project Settings > API > anon/public key.
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token obtained from /login endpoint.
        Include in Authorization header as: Bearer <token>
        Required for authenticated endpoints like /logout and creating ADMIN users.
